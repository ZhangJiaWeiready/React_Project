import React, {Component} from 'react'import {NavBar,List,InputItem,Grid,Icon} from 'antd-mobile'import {connect} from 'react-redux'import QueueAnim from 'rc-queue-anim'import {sendMsgs,readMsg} from '../../redux/actions'const Item = List.Itemclass Chat extends Component{    /*    *  thumb -- ç”¨æˆ·å¤´åƒ    * */    state ={        content:'',        isShow:false // æ˜¯å¦æ˜¾ç¤ºè¡¨æƒ…åˆ—è¡¨    }    // åœ¨ç¬¬ä¸€æ¬¡render()ä¹‹å‰å›è°ƒ    componentWillMount () {        // åˆå§‹åŒ–è¡¨æƒ…åˆ—è¡¨æ•°æ®        const emojis = ['ğŸ¤£', 'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£','ğŸ˜€'            ,'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£'            ,'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£'            ,'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£','ğŸ˜€', 'ğŸ˜', 'ğŸ¤£']        this.emojis = emojis.map(emoji => ({text: emoji}))    }    componentDidMount() {        // åˆå§‹æ˜¾ç¤ºåˆ—è¡¨        window.scrollTo(0, document.body.scrollHeight)    }    componentDidUpdate () {        // æ›´æ–°æ˜¾ç¤ºåˆ—è¡¨        window.scrollTo(0, document.body.scrollHeight)    }    //åœ¨é€€å‡ºçš„æ—¶å€™æ›´æ–°countçš„æ•°é‡ï¼Œåœ¨ç»“æŸçš„æ—¶å€™è·å¾—æ•°é‡  å°†æ˜¾ç¤ºçš„æ•°é‡æ”¹å˜    componentWillUnmount () {        //å‘é€è¯·æ±‚æ›´æ–°æ¶ˆæ¯çš„æœªè¯»çŠ¶æ€ å¿…é¡»æ˜¯åŒä¸€ä¸ªäººå‘ç»™æˆ‘çš„æ¶ˆæ¯        const from = this.props.match.params.userid        const to = this.props.user._id        this.props.readMsg(from,to)    }    toggleShow = () => {        const isShow = !this.state.isShow        this.setState({isShow})        if(isShow) {            // å¼‚æ­¥æ‰‹åŠ¨æ´¾å‘resizeäº‹ä»¶,è§£å†³è¡¨æƒ…åˆ—è¡¨æ˜¾ç¤ºçš„bug            setTimeout(() => {                window.dispatchEvent(new Event('resize'))            }, 0)        }    }    handleSend = () =>{        const from = this.props.user._id        console.log(from) //5ae516a03b563549f4f946c3        const to = this.props.match.params.userid        const content = this.state.content.trim()        //å‘é€è¯·æ±‚ å‘é€æ¶ˆæ¯ -- å‰æå¿…é¡»æ˜¯contentæœ‰å€¼        if(content) {            this.props.sendMsgs({from,to,content})        }        this.setState({            content:'',            isShow: false        })    }    render() {        const {user} = this.props        const {users,chatMsgs} = this.props.chat        // è®¡ç®—å½“å‰èŠå¤©çš„chat_id --        const meId = user._id        if(!users[meId]){ //åˆ¤æ–­å¦‚æœè¿˜æ²¡æœ‰è·å–æ•°æ® ç›´æ¥ä¸åšä»»ä½•æ˜¾ç¤º return            return null        }        const targetId = this.props.match.params.userid        console.log(targetId)        const chatId = [meId,targetId].sort().join('_')        //chatMsgs åŒ…å«æ‰€æœ‰äººçš„ä¿¡æ¯ æ‰€ä»¥éœ€è¦è¿‡æ»¤ï¼Œchat_id            // åŒ…å«å¯¹æ–¹å‘ç»™æˆ‘ è¿˜æœ‰æˆ‘å‘ç»™å¯¹æ–¹çš„ä½†æ˜¯æ˜¾ç¤ºçš„ä½ç½®ä¸ä¸€æ ·        const msgs = chatMsgs.filter(msg => msg.chat_id === chatId)        //å¾—åˆ°ç›®æ ‡ç”¨æˆ·çš„å¤´åƒ headerå›¾åƒ  ç›®æ ‡ç”¨æˆ·çš„idçŸ¥é“ ç›®æ ‡ç”¨æˆ·çš„useré‚£ä¹ˆå’Œheaderç»„æˆä¸€ä¸ªå¯¹è±¡        // æœ‰å¯èƒ½æ³¨å†Œçš„ç”¨æˆ·æ²¡æœ‰å¤´åƒ æœ‰çš„è¯æ˜¾ç¤ºæ²¡æœ‰çš„è¯å°±æ˜¾ç¤º        // useræœ€åˆçš„æ—¶å€™æ˜¯ç©ºå¯¹è±¡        const targetHeader = users[targetId].header        const targetIcon = targetHeader ? require(`../../assets/images/${targetHeader}.png`) : null        return(            <div id='chat-page'>                <NavBar                    icon={<Icon type='left'/>}                    className='sticky-header'                    onLeftClick={()=> this.props.history.goBack()}                >{users[targetId].username}</NavBar>                <QueueAnim type='scale' delay={100}>                    {msgs.map(msg => {                        const avatar = require(`../../assets/images/${users[msg.from].header}.png`)                        if (msg.from === user._id) {                            return (                                <Item                                    key={msg._id}                                    thumb={avatar}                                >{msg.content}</Item>                            )                        } else {                            return (                                <Item                                    key={msg._id}                                    extra={<img src={avatar}/>}                                    className='chat-me'                                >{msg.content}</Item>                            )                        }                    })}                </QueueAnim>                {/*<List style={{marginTop:50, marginBottom: 60}}>                    {msgs.map( msg =>{                        if(meId === msg.to){                            return  (<Item                                key={msg._id}                                thumb={targetIcon}                            >                                {msg.content}                            </Item>)                        }else {                            return (<Item                                key={msg._id}                                className='chat-me'                                extra='æˆ‘'                            >                                {msg.content}                            </Item>)                        }                    })}                </List>*/}                <div className='am-tab-bar'>                    <InputItem                        style={{marginBottom:0}}                        className='Input'                        onFocus={() => this.setState({isShow: false})}                        value={this.state.content}                        placeholder='è¯·è¾“å…¥'                        extra={                            <span>                                <span onClick={this.toggleShow} style={{marginRight:5}}>ğŸ˜Š</span>                                 <span onClick={this.handleSend}>å‘é€</span>                            </span>                        }                        onChange={(val) => this.setState({content:val})}                    />                    {this.state.isShow ? (                        <Grid                            data={this.emojis}                            columnNum={8}                            carouselMaxRow={4}                            isCarousel={true}                            onClick={(item) => {                                this.setState({content: this.state.content + item.text})                            }}                        />                    ) : null}                </div>            </div>        )    }}export default connect(    state=>({user:state.user,chat:state.chat}),    {sendMsgs,readMsg})(Chat)